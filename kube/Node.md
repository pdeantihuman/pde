# 节点

节点是Kubernetes的一台工作机，以前被称为`minion`。节点可以是虚拟机或物理机，具体取决于集群。每个节点包含运行pod所需的服务，并由主组件管理。节点上的服务包括容器运行时、kubelet和kube-proxy。有关更多详细信息，请参见架构设计文档中的Kubernetes节点部分。

 

- 节点状态
- 管理
- 节点拓扑
- API对象

 

## 节点状态

节点的状态包含以下信息:

- 地址Address
- 情况Conditions
- 容量Capacity和可分配性Allocatable
- 信息Info

可以使用以下命令显示节点状态和关于节点的其他详细信息:

```
kubectl describe node 
```

下面详细描述了每个部分。

### 地址Address

这些字段的使用因云提供商或裸机配置而异。

- 主机名:节点内核报告的主机名。可以通过kubelet - hostname-override参数重写。
- 外部地址:通常是可从外部路由的节点的地址(可从集群外部获得)。
- 内部地址:通常是只能在集群内路由的节点的IP地址。

### 情况Conditions

情况字段描述所有正在运行的节点的状态。条件的例子包括:

| 节点情况           | Description                                                  |
| ------------------ | ------------------------------------------------------------ |
| Ready              | 如果节点运行正常并准备接受pod，则为`True`；如果节点不运行正常且不接受pod，则为`False`；如果节点控制器在最后一个`node-monitor-grace-period`内没有收到该节点的消息，则为`Unknown`(默认值为40秒)。 |
| MemoryPressure     | 如果节点内存有压力，即节点内存太少，则为`True`；否则为`False` |
| PIDPressure        | 如果进程存在压力，即节点上有太多进程，则为`True`；否则为`False` |
| DiskPressure       | 如果节点硬盘有压力。即节点硬盘容量太小，则为`True`，否则为`False` |
| NetworkUnavailable | 如果节点的网络没有被正确配置，则为`True`，否则为`False`。    |

节点情况由JSON对象表示。例如，以下响应描述了健康节点。 

```json
"conditions": [
  {
    "type": "Ready",
    "status": "True",
    "reason": "KubeletReady",
    "message": "kubelet is posting ready status",
    "lastHeartbeatTime": "2019-06-05T18:38:35Z",
    "lastTransitionTime": "2019-06-05T11:41:27Z"
  }
]
```

如果就绪状态保持`Unknown`或`False`的时间长于 `pod-eviction-timeout`(节点驱逐超时时间)，则参数被传递给 kube-controller-manager ，并且节点上的所有pod都被节点控制器计划删除。默认驱逐超时持续时间为五分钟。在某些情况下，当节点不可访问时，apiserver无法与节点上的kubelet通信。在与apiserver重新建立通信之前，无法将删除pod的决定传达给kubelet。同时，计划删除的pod可能会继续在分区节点上运行。

在1.5之前版本的Kubernetes中，节点控制器会强制从apiserver中删除这些不可访问的 Pod 。但是，在1.5及更高版本中，节点控制器不会强制删除 Pod ，直到确认它们已停止在集群中运行。您可以看到在不可达节点上运行的 Pod 处于终止或未知状态。如果Kubernetes无法从底层基础设施推断出一个节点是否已经永久离开集群，集群管理员可能需要手动删除该节点对象。从Kubernetes中删除节点对象会导致节点上运行的所有Pod对象从apiserver中删除，并释放它们的名称。

在1.12版中，`TaintNodesByCondition` 特性被提升为beta，因此节点生命周期控制器会自动创建表示条件的污点taints。类似地，调度器在考虑节点时忽略条件；相反，它关注节点的污点`taints`和Pod的容忍度`tolerations`。

现在用户可以在旧的调度模型和新的更灵活的调度模型之间进行选择。一个没有任何容忍度的Pod会根据旧模型进行调度。但是可以在特定节点上调度容忍该节点污染的Pod。

### 容量Capacity和可分配性

这个字段描述节点上可用的资源:CPU、内存和可调度到节点上的最大 Pod 数。

容量块中的字段指示节点拥有的资源总量。可分配块表示节点上可供普通pod消耗的资源量。

在学习如何在节点上保留计算资源时，您可以阅读更多关于容量和可分配资源的内容。

### 信息Info

描述有关该节点的一般信息，例如内核版本、 Kubernetes 版本(库本莱和库本代理版本)、Docker版本(如果使用)和操作系统名称。 Kubelet 从该节点收集这些信息。 

## Management

与pods和服务不同，节点并不是 Kubernetes 固有地创建的:它是由像谷歌计算引擎这样的云提供商在外部创建的，或者它存在于您的物理或虚拟机池中。因此，当 Kubernetes 创建一个节点时，它会创建一个表示该节点的对象。创建后，Kubernetes检查节点是否有效。例如，如果您试图从以下内容创建节点:

```json
{
  "kind": "Node",
  "apiVersion": "v1",
  "metadata": {
    "name": "10.240.79.157",
    "labels": {
      "name": "my-first-k8s-node"
    }
  }
}
```

Kubernetes在内部创建一个节点对象(表示)，并通过基于`metadata.name`字段的运行状况检查来验证该节点。如果该节点有效，即如果所有必要的服务都在运行，则它有资格运行pod。否则，任何集群活动都将忽略它，直到它生效。

{% hint style="info" %}
注意:Kubernetes会为无效节点保留对象，并不断检查它是否有效。您必须显式删除节点对象才能停止此过程。
{% endhint %}

目前，有三个组件与Kubernetes节点接口交互:节点控制器、kubelet和kubectl。

### 节点控制器

节点控制器是 Kubernetes 主组件，管理节点的各个方面。

节点控制器在一个节点的生命中有多个角色。第一种是在节点注册时为其分配一个CIDR块(如果CIDR分配已打开)。

第二是让节点控制器的内部节点列表与云提供商的可用机器列表保持同步。在云环境中运行时，每当节点不健康时，节点控制器都会询问云提供商该节点的虚拟机是否仍然可用。如果不是，节点控制器从其节点列表中删除该节点。

第三是监控节点的健康状况。当一个节点变得不可达时(即，节点控制器由于某种原因，例如由于节点关闭而停止接收心跳)，节点控制器负责将节点状态的节点就绪状态更新为未知状态，然后如果该节点仍然不可达，则稍后从该节点驱逐所有 Pod (使用优雅的终止)。(默认超时是40s开始报告条件`Unknown`，然后5m开始驱逐container。)节点控制器每隔一个节点监视周期秒检查每个节点的状态。

在1.13之前版本的Kubernetes中，节点状态是来自节点的心跳。默认情况下，自1.14起，节点租用功能作为测试功能启用(功能门节点租用，KEP-0009)。启用节点租约功能时，每个节点在kube节点租约命名空间中都有一个关联的租约对象，该对象由节点定期更新，节点状态和节点租约都被视为来自该节点的心跳。节点租约会定时续订，而节点状态仅在发生一些更改或经过足够长的时间时才会从节点报告给主节点(默认值为1分钟，这比无法到达的节点的默认超时时间40秒长)。因为节点租用比节点状态轻得多，所以从可伸缩性和性能的角度来看，这一特性使得节点心跳显著降低。

在Kubernetes 1.4中，我们更新了节点控制器的逻辑，以便更好地处理大量节点在到达主节点时出现问题的情况(例如，因为主节点有网络问题)。从1.4开始，节点控制器在决定pod驱逐时会查看集群中所有节点的状态。

在大多数情况下，节点控制器将逐出速率限制为每秒一个节点的逐出速率(默认为0.1)，这意味着它不会每10秒钟从一个以上的节点逐出 Pod 。

当给定可用性区域中的节点变得不健康时，节点驱逐行为会发生变化。节点控制器同时检查区域中有多少百分比的节点不健康(节点就绪状态为条件未知或条件假)。如果不健康节点的比例至少为-不健康区域阈值(默认值0.55)，则驱逐率降低:如果集群很小(即，具有小于或等于-大集群大小阈值节点-默认值50)，则驱逐停止，否则驱逐率降低到每秒-次节点驱逐率(默认值0.01)。每个可用性区域实施这些策略的原因是，一个可用性区域可能会与主区域隔离，而其他区域保持连接。如果您的集群不跨越多个云提供商可用性区域，则只有一个可用性区域(整个集群)。

将您的节点分布在可用性区域的一个关键原因是，当整个区域宕机时，工作负载可以转移到健康区域。因此，如果一个区域中的所有节点都不健康，则节点控制器以正常的节点驱逐速率驱逐。拐角情况是所有区域都完全不健康(即集群中没有健康节点)。在这种情况下，节点控制器假设主连接有问题，并停止所有驱逐，直到恢复一些连接。

从Kubernetes 1.6开始，节点控制器还负责驱逐运行在有`no-execute`污染的节点上的 Pod ，当 Pod 不能容忍污染时。此外，作为默认禁用的alpha功能，节点控制器负责添加与节点问题(如节点不可访问或未准备好)相对应的污点。有关无可见性污点和阿尔法特性的详细信息，请参见本文档。

从1.8版开始，节点控制器可以负责创建代表节点条件的污点。这是1.8版的阿尔法特性。

### 节点的自注册Self Registration

当kubelet标志 `--register-node`为`True`(默认)时，这个kubelet将尝试向API服务器注册自己。这是大多数发行版的首选模式。

对于自我注册，kubelet从以下选项开始:

- `--kube-config`-验证您到apiserver的凭据路径。
- `--cloud-provider`-如何与云提供商交谈以了解他们自己的元数据。
- `--register-node`-自动向API服务器注册。
- `--register-with-taints`-用给定的着色列表注册节点(逗号分隔`<key>=<value>:<effect>`).如果`register-node`为`False`，则没有操作。
- `--node-ip`-节点的ip-IP地址。
- `--node-labels`-在集群中注册节点时要添加的标签(参见1.13+中节点限制准入插件施加的标签限制)。
- `--node-status-update-frequency`-指定kubelet向主节点发布节点状态的频率。
- 当启用节点授权模式和节点限制准入插件时，kubelet仅被授权创建/修改自己的节点资源。

