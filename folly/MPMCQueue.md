# MPMCQueue

多生产者、多消费者、无锁共享队列

MultiProducer MultiConsumer lockless shared queue

`MPMCQueue<T>`是一个高性能的有界并发队列，支持多个生产者、多个消费者和可选的阻塞。队列有一个固定的容量，所有的内存都将预先分配。入队和出队的大部分工作可以并行进行。

MPMCQueue是可线性化的。这意味着，如果写(A)的调用在写(B)的调用开始之前返回，那么A肯定会在写(B)的调用之前结束在队列中，如果读(X)的调用在读(Y)的调用开始之前返回，那么X将是队列中比Y更早的某个对象。这也意味着，如果读调用返回一个值，您可以确定队列中所有先前的元素都已经被分配了一个读取器(该读取器可能还没有返回，但是它存在)。

MPMCQueue是保序的。

底层实现使用票据分配器作为头和尾，将访问分散到N个单元素队列中以产生容量为N的队列。票据分配器使用原子增量，这比CAS循环对争用更鲁棒。每个单元素队列都使用自己的CAS来序列化访问，并具有自适应的自旋截断。当在单元素队列上旋转失败时，它使用futex()的_ BITSET操作来减少不必要的唤醒，即使单个队列上存在多个等待者(例如当MPMCQueue的容量小于入队或出队的数量时)。

在基准测试中(包含在Tao/queues/ConcurrentqueueTests中)，无论是小容量(~10)还是大容量，它处理1到1、1到N、N到1和N到M线程计数都优于fbcode中的任何替代方案。在这些基准测试中，对于所有配置，它也比TBB::concurrent _ bound _ queue更快。当线程比内核多得多时，MPMCQueue比tbb队列快得多，因为它使用futex()来阻塞和解除阻塞等待的线程，而不是以sched_yield的速度旋转。

